#!/usr/bin/env bash

set -euo pipefail

usage() {
  cat <<EOF >&2
Usage: ${0##*/} <qcow2-path> <ssh-port>
Try '${0##*/} --help' for more details.
EOF
  exit "${1:-2}"
}

help() {
  cat <<'EOF'
NAME
  run - Boot an installed ARM64 qcow2 image with host SSH port forward

SYNOPSIS
  run <qcow2-path> <ssh-port>

DESCRIPTION
  Launches qemu-system-aarch64 with the given qcow2 disk image and forwards
  host TCP <ssh-port> to the guest's port 22 for SSH access.

OPTIONS
  -h, --help            Show this help and exit

ARGUMENTS
  <qcow2-path>          Path to the qcow2 disk image to boot
  <ssh-port>            Host TCP port to forward to guest 22

EXAMPLES
  run ./qcow2s/debian12.qcow2 2222

EXIT STATUS
  0  Success
  2  Usage error (invalid args)
EOF
  exit 0
}

# Parse options and positional args
QCOW2_IMG=""
while [ $# -gt 0 ]; do
  case "$1" in
    -h|--help) help ;;
    --) shift; break ;;
    -*) echo "${0##*/}: unknown option: $1" >&2; usage ;;
    *) QCOW2_IMG="$1"; shift; break ;;
  esac
done

[ -n "$QCOW2_IMG" ] || usage
[ $# -ge 1 ] || usage
SSH_PORT="$1"; shift
[ $# -eq 0 ] || usage

if [ ! -f "$QCOW2_IMG" ]; then
  echo "./${0##*/}: couldn't read \`$QCOW2_IMG\`: No such file or directory"
  exit 1
fi

set -x

qemu-system-x86_64 \
  -enable-kvm \
  -m 4G -cpu host -smp cores=4 \
  -boot menu=on \
  -drive format=qcow2,file="${QCOW2_IMG_PATH}"

