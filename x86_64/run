#!/usr/bin/env bash

set -e

usage() {
  cat <<EOF >&2
Usage: ${0##*/} <qcow2-path>
Try '${0##*/} --help' for more details.
EOF
  exit "${1:-2}"
}

help() {
  cat <<'EOF'
NAME
  run - Boot an installed x86_64 qcow2 image

SYNOPSIS
  run <qcow2-path>

DESCRIPTION
  Launches qemu-system-x86_64 with the given qcow2 disk image.

OPTIONS
  -h, --help            Show this help and exit

ARGUMENTS
  <qcow2-path>          Path to the qcow2 disk image to boot

EXAMPLES
  run ./qcow2s/debian12.qcow2

EXIT STATUS
  0  Success
  2  Usage error (invalid args)
EOF
  exit 0
}

if [[ -n $1 ]]; then
  case "$1" in
    -h|--help) help ;;
    -*) echo "${0##*/}: unknown option: $1" >&2; usage ;;
  esac
  QCOW2_IMG_PATH=$1
else
  usage
  exit 1
fi

if [[ ! -f "$QCOW2_IMG_PATH" ]]; then
  echo "./${0##*/}: couldn't read \`$QCOW2_IMG_PATH\`: No such file or directory" >/dev/stderr
  exit 1
fi

set -x

qemu-system-x86_64 \
  -enable-kvm \
  -m 4G -cpu host -smp cores=4 \
  -boot menu=on \
  -drive format=qcow2,file="${QCOW2_IMG_PATH}"

